<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>World Map Selector</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { margin: 0; font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif; font-size: 16px; }
        
        /* Back button styling - responsive positioning */
        .back-button-container {
            position: absolute;
            top: 0;
            left: 0;
            padding: 20px 0 0 20px;
            z-index: 1000;
        }
        
        .back-button {
            background: #2a4d69;
            color: white;
            padding: 10px 18px;
            border-radius: 6px;
            text-decoration: none;
            font-weight: 600;
            font-size: 1em;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }
        
        .back-button:hover {
            background: #41729f;
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0,0,0,0.3);
        }
        
        #container { 
            display: flex; 
            height: 100vh; 
            background: linear-gradient(120deg, #e0eafc 0%, #cfdef3 100%); 
            position: relative;
        }
        #map { flex: 3; height: 100vh; border-radius: 18px 0 0 18px; box-shadow: 0 4px 24px rgba(44,62,80,0.10); }
        #sidebar {
            flex: 1;
            background: #b0c4de;
            padding: 70px 23px 24px 24px;
            box-shadow: 0 0 18px #b0c4de;
            border-radius: 0 18px 18px 0;
            border-left: 6px solid #000;
            display: flex;
            flex-direction: column;
            min-width: 340px;
            position: relative;
        }
        #sidebar h2 {
            font-size: 1.6em;
            font-weight: 700;
            margin-bottom: 12px;
            margin-top: 2;
        }
        #region { font-size: 1.3em; margin-top: 20px; color: #2a4d69; font-weight: 500; }
        #elevation { font-size: 1.2em; margin-top: 20px; color: #41729f; font-weight: 500; }
        #flood-directions h3 { color: #2a4d69; margin-bottom: 10px; font-size: 1.3em; font-weight: 600; }
        #flood-directions div {
            font-size: 1.1em;
            margin-bottom: 8px;
            line-height: 1.5;
        }
        
        /* Disaster Info Button */
        #disaster-btn {
            margin-top: 20px;
            width: 100%;
            padding: 14px 20px;
            background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(243, 156, 18, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        #disaster-btn:hover {
            background: linear-gradient(135deg, #e67e22 0%, #d35400 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(243, 156, 18, 0.4);
        }
        
        #disaster-btn:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
            transform: none;
        }
        
        /* Popup Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            animation: fadeIn 0.3s ease;
        }
        
        .modal-content {
            background: #bbcdf0;
            margin: 8% auto;
            padding: 30px;
            border-radius: 16px;
            width: 90%;
            max-width: 600px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            animation: slideDown 0.3s ease;
            position: relative;
            border: 5px solid #073278;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 4px solid #f39c12;
        }
        
        .modal-header h2 {
            color: #d68910;
            font-size: 1.6em;
            font-weight: 700;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .close-btn {
            background: none;
            border: none;
            font-size: 2em;
            color: #7f8c8d;
            cursor: pointer;
            transition: all 0.2s ease;
            padding: 0;
            width: 35px;
            height: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }
        
        .close-btn:hover {
            background: #ecf0f1;
            color: #2c3e50;
        }
        
        .modal-body {
            font-size: 1.1em;
            line-height: 1.7;
            color: #2c3e50;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .modal-body.loading {
            text-align: center;
            font-style: italic;
            color: #7f8c8d;
            padding: 40px 20px;
        }
        
        .modal-body.error {
            color: #c0392b;
            text-align: center;
            padding: 20px;
        }
        
        /* City Search Button - Bottom Left */
        #city-search-btn {
            position: fixed;
            bottom: 30px;
            left: 30px;
            z-index: 1500;
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            color: white;
            padding: 14px 24px;
            border: none;
            border-radius: 10px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(52, 152, 219, 0.4);
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        #city-search-btn:hover {
            background: linear-gradient(135deg, #2980b9 0%, #21618c 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(52, 152, 219, 0.5);
        }
        
        /* City Search Modal */
        .city-modal-content {
            background: #bbcdf0;
            margin: 15% auto;
            padding: 30px;
            border-radius: 16px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            animation: slideDown 0.3s ease;
            position: relative;
            border: 5px solid #073278;
        }
        
        .search-input-container {
            position: relative;
            margin-top: 20px;
        }
        
        #city-input {
            width: 100%;
            padding: 14px 16px;
            font-size: 1.1em;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            outline: none;
            font-family: 'Inter', sans-serif;
            transition: all 0.3s ease;
            box-sizing: border-box;
        }
        
        #city-input:focus {
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }
        
        /* Dropdown suggestions */
        #city-suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: #b0c4de;
            border: 2px solid #e0e0e0;
            border-top: none;
            border-radius: 0 0 10px 10px;
            max-height: 300px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        .city-suggestion-item {
            padding: 12px 16px;
            cursor: pointer;
            transition: background 0.2s ease;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .city-suggestion-item:last-child {
            border-bottom: none;
        }
        
        .city-suggestion-item:hover {
            background: #e3f2fd;
        }
        
        .city-suggestion-item .city-name {
            font-weight: 600;
            color: #2c3e50;
        }
        
        .city-suggestion-item .city-details {
            font-size: 0.9em;
            color: #7f8c8d;
            margin-top: 2px;
        }
        
        .no-results {
            padding: 16px;
            text-align: center;
            color: #7f8c8d;
            font-style: italic;
        }
        
        .loading-suggestions {
            padding: 16px;
            text-align: center;
            color: #3498db;
        }
        
        /* ========================================
           ELEVATION LEGEND STYLING 
           Adjust padding, margin-top, margin-left, 
           margin-right, and positioning here
           ======================================== */
        #legend {
            margin-top: auto;        /* Adjust vertical position (e.g., 20px, auto) */
            padding: 10px;          /* Adjust internal spacing */
            background: #9dafc7;
            border: 3px solid #073278;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 2px 8px #e0eafc;
            width: 100%;
            max-width: 100%;
            margin-left: -10px;         /* Adjust horizontal position from left */
            margin-right: 0px;        /* Adjust horizontal position from right */
        }
        #legend strong {
            font-size: 1.1em;
            font-weight: 600;
        }
        #legend svg {
            width: 100% !important;
            min-width: 180px;
            max-width: 100%;
            display: block;
            margin: 8px 0;
        }
        #legend img { width: 100%; max-width: 180px; display: block; margin: 8px 0; }
    </style>
</head>
<body>
<div id="container">
    <div id="map"></div>
    <div id="sidebar">
        <div class="back-button-container">
            <a href="/" class="back-button">
                <span>←</span> Back to Home
            </a>
        </div>
        <h2>Selected Region</h2>
        <div id="region">Click on the map to select a location.</div>
        <div id="elevation">Elevation: <span id="elev-value">-</span> m</div>
        <div id="flood-directions" style="margin-top:20px;">
            <h3>Flood Evacuation Directions</h3>
            <div id="flood-1m">1m flood: <span>-</span></div>
            <div id="flood-2_5m">2.5m flood: <span>-</span></div>
            <div id="flood-5m">5m flood: <span>-</span></div>
        </div>
        
        <button id="disaster-btn" disabled>
            <span>⚠️</span> View Natural Disaster Risks
        </button>

        <div id="legend">
            <strong>Elevation Legend</strong><br>
            <svg width="100%" height="20" style="display:block;margin:8px 0;">
                <defs>
                    <linearGradient id="elev-gradient" x1="0" x2="1" y1="0" y2="0">
                        <stop offset="0%" stop-color="#0077ff" /> <!-- Blue -->
                        <stop offset="25%" stop-color="#22bb33" /> <!-- Green -->
                        <stop offset="50%" stop-color="#ffff00" /> <!-- Yellow -->
                        <stop offset="75%" stop-color="#ff2222" /> <!-- Red -->
                        <stop offset="100%" stop-color="#8B4513" /> <!-- Brown -->
                    </linearGradient>
                </defs>
                <rect x="0" y="0" width="100%" height="20" fill="url(#elev-gradient)" />
            </svg>
            <div style="display: flex; justify-content: space-between; font-size:0.9em;">
                <span>Low</span>
                <span>High</span>
            </div>
        </div>
    </div>
</div>

<!-- City Search Button -->
<button id="city-search-btn">
    <span>📍</span> Enter Location
</button>

<!-- City Search Modal -->
<div id="city-search-modal" class="modal">
    <div class="city-modal-content">
        <div class="modal-header">
            <h2><span>📍</span> Search for a Location</h2>
            <button class="close-btn" onclick="closeCitySearchModal()">&times;</button>
        </div>
        <div class="search-input-container">
            <input 
                type="text" 
                id="city-input" 
                placeholder="Type a location (i.e. Toronto; Alaska; Hong Kong etc...)" 
                autocomplete="off"
            />
            <div id="city-suggestions"></div>
        </div>
    </div>
</div>

<!-- Disaster Info Modal -->
<div id="disaster-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2><span>⚠️</span> Natural Disaster Risks</h2>
            <button class="close-btn" onclick="closeDisasterModal()">&times;</button>
        </div>
        <div id="modal-body" class="modal-body">
            Click on a location to learn about potential natural disasters in that area.
        </div>
    </div>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
    var map = L.map('map').setView([20, 0], 2);
    L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
        maxZoom: 17,
        attribution: 'Map data: © OpenStreetMap contributors, SRTM | Map style: © OpenTopoMap (CC-BY-SA)' 
    }).addTo(map);
    var marker;
    var routeLayer = null;
    var routeLayers = []; // Array to track multiple route layers
    var currentDisasterInfo = null; // Store disaster info
    
    // Check for URL parameters to navigate to specific location
    const urlParams = new URLSearchParams(window.location.search);
    const urlLat = urlParams.get('lat');
    const urlLng = urlParams.get('lng');
    
    if (urlLat && urlLng) {
        // Wait for map to be ready, then navigate to the coordinates
        setTimeout(() => {
            selectCity(urlLat, urlLng, 'Selected Location');
        }, 500);
    }
    
    function openDisasterModal() {
        document.getElementById('disaster-modal').style.display = 'block';
    }
    
    function closeDisasterModal() {
        document.getElementById('disaster-modal').style.display = 'none';
    }
    
    // Close modal when clicking outside of it
    window.onclick = function(event) {
        const disasterModal = document.getElementById('disaster-modal');
        const cityModal = document.getElementById('city-search-modal');
        if (event.target == disasterModal) {
            closeDisasterModal();
        }
        if (event.target == cityModal) {
            closeCitySearchModal();
        }
    }
    
    // Close modal on Escape key
    document.addEventListener('keydown', function(event) {
        if (event.key === 'Escape') {
            closeDisasterModal();
            closeCitySearchModal();
        }
    });
    
    // Button click handler
    document.getElementById('disaster-btn').addEventListener('click', openDisasterModal);
    
    // City Search Modal Functions
    function openCitySearchModal() {
        document.getElementById('city-search-modal').style.display = 'block';
        document.getElementById('city-input').focus();
    }
    
    function closeCitySearchModal() {
        document.getElementById('city-search-modal').style.display = 'none';
        document.getElementById('city-input').value = '';
        document.getElementById('city-suggestions').style.display = 'none';
        document.getElementById('city-suggestions').innerHTML = '';
    }
    
    // City search button click handler
    document.getElementById('city-search-btn').addEventListener('click', openCitySearchModal);
    
    // Debounce function for search input
    let searchTimeout;
    function debounce(func, delay) {
        return function(...args) {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => func.apply(this, args), delay);
        };
    }
    
    // Search for cities using Nominatim API
    async function searchCities(query) {
        if (query.length < 2) {
            document.getElementById('city-suggestions').style.display = 'none';
            return;
        }
        
        const suggestionsDiv = document.getElementById('city-suggestions');
        suggestionsDiv.innerHTML = '<div class="loading-suggestions">🔍 Searching...</div>';
        suggestionsDiv.style.display = 'block';
        
        try {
            const response = await fetch(
                `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=8&addressdetails=1`
            );
            const results = await response.json();
            
            if (results.length === 0) {
                suggestionsDiv.innerHTML = '<div class="no-results">No locations found. Try a different name.</div>';
                return;
            }
            
            // Display results
            suggestionsDiv.innerHTML = '';
            results.forEach(result => {
                const item = document.createElement('div');
                item.className = 'city-suggestion-item';
                
                const displayName = result.display_name;
                const parts = displayName.split(',');
                const cityName = parts[0];
                const details = parts.slice(1).join(',');
                
                item.innerHTML = `
                    <div class="city-name">${cityName}</div>
                    <div class="city-details">${details}</div>
                `;
                
                item.addEventListener('click', () => {
                    selectCity(result.lat, result.lon, displayName);
                });
                
                suggestionsDiv.appendChild(item);
            });
        } catch (error) {
            console.error('Error searching cities:', error);
            suggestionsDiv.innerHTML = '<div class="no-results">Error searching. Please try again.</div>';
        }
    }
    
    // Select a city from dropdown
    function selectCity(lat, lng, name) {
        const latNum = parseFloat(lat);
        const lngNum = parseFloat(lng);
        
        // Close the modal
        closeCitySearchModal();
        
        // Pan and zoom to the location
        map.setView([latNum, lngNum], 10, {
            animate: true,
            duration: 1
        });
        
        // Simulate a click on the map at that location after a short delay
        setTimeout(() => {
            if (marker) map.removeLayer(marker);
            marker = L.marker([latNum, lngNum]).addTo(map);
            
            setRegionName('Loading...');
            
            // Fetch elevation
            fetch(`/elevation?lat=${latNum}&lng=${lngNum}`)
                .then(res => res.json())
                .then(data => {
                    let elev = (data && data.results && data.results[0] && data.results[0].elevation !== undefined && data.results[0].elevation !== null) ? data.results[0].elevation : NaN;
                    setElevation(elev, latNum, lngNum, 0);
                })
                .catch(() => setElevation('N/A', latNum, lngNum, 0));
            
            // Set region name and fetch disaster info
            setRegionName(name.split(',')[0]);
            fetchDisasterInfo(latNum, lngNum, name.split(',')[0]);
        }, 500);
    }
    
    // Add input event listener with debounce
    document.getElementById('city-input').addEventListener('input', debounce(function(e) {
        searchCities(e.target.value);
    }, 300));
    
    function clearRoute() {
        // Clear the main route layer
        if (routeLayer) {
            map.removeLayer(routeLayer);
            routeLayer = null;
        }
        // Clear all route layers from the array
        routeLayers.forEach(layer => {
            if (map.hasLayer(layer)) {
                map.removeLayer(layer);
            }
        });
        routeLayers = []; // Reset the array
    }

    function setRegionName(name) {
        document.getElementById('region').textContent = name;
    }
    
    async function fetchDisasterInfo(lat, lng, regionName) {
        const modalBody = document.getElementById('modal-body');
        const disasterBtn = document.getElementById('disaster-btn');
        
        // Enable button immediately - no loading state
        disasterBtn.disabled = false;
        
        // Set initial modal content to loading (but don't change button)
        modalBody.className = 'modal-body loading';
        modalBody.innerHTML = '🔄 Loading disaster information...';
        
        try {
            const response = await fetch('/location-disasters', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ 
                    lat: lat, 
                    lng: lng, 
                    region: regionName 
                })
            });
            
            const data = await response.json();
            
            if (data.status === 'success') {
                modalBody.className = 'modal-body';
                modalBody.innerHTML = data.response;
                currentDisasterInfo = data.response;
            } else {
                modalBody.className = 'modal-body error';
                modalBody.innerHTML = '❌ Unable to load disaster information. Please try again.';
            }
        } catch (error) {
            console.error('Error fetching disaster info:', error);
            modalBody.className = 'modal-body error';
            modalBody.innerHTML = '❌ Network error. Please check your connection.';
        }
    }
    
    function setElevation(value, lat, lng, prevElevation) {
        let elevation = value;
        if (elevation === null || elevation === undefined || isNaN(elevation)) {
            // If elevation is not a number, use previous elevation if valid, else 0
            if (prevElevation !== undefined && prevElevation !== null && !isNaN(prevElevation)) {
                elevation = prevElevation;
            } else {
                elevation = 0;
            }
        }
        document.getElementById('elev-value').textContent = elevation;
        setFloodDirections(elevation, lat, lng);
    }
    function setFloodDirections(elevation, lat, lng) {
        const floodLevels = [1, 2.5, 5];
        clearRoute && clearRoute();
        floodLevels.forEach(async level => {
            let dir = '-';
            if (elevation !== null && elevation !== 'N/A' && !isNaN(elevation)) {
                if (elevation < level) {
                    dir = 'Move to higher ground!';
                } else if (elevation < level + 10) {
                    dir = 'Caution: Seek higher elevation nearby.';
                    // Find nearest higher ground and draw route
                    let target = await getNearestHigherGround(lat, lng, level + 2, elevation);
                    if (target) {
                        drawRouteToSafety(lat, lng, target[0], target[1]);
                    }
                } else {
                    dir = 'You are likely safe from a ' + level + 'm flood.';
                }
            }
            document.querySelector(`#flood-${level.toString().replace('.', '_')}m span`).textContent = dir;
        });
    }
    async function getNearestHigherGround(lat, lng, minElevation, currentElevation) {
        // Search in a spiral pattern for a nearby point with higher elevation
        // For demo, try 8 directions at 1km, 2km, 3km, 4km, 5km
        const R = 6371; // Earth radius in km
        for (let d = 1; d <= 5; d++) {
            for (let angle = 0; angle < 360; angle += 45) {
                let rad = angle * Math.PI / 180;
                let dLat = d * Math.cos(rad) / R * (180 / Math.PI);
                let dLng = d * Math.sin(rad) / (R * Math.cos(lat * Math.PI / 180)) * (180 / Math.PI);
                let nLat = lat + dLat;
                let nLng = lng + dLng;
                try {
                    let resp = await fetch(`/elevation?lat=${nLat}&lng=${nLng}`);
                    let data = await resp.json();
                    let elev = (data && data.results && data.results[0] && data.results[0].elevation !== undefined && data.results[0].elevation !== null) ? data.results[0].elevation : NaN;
                    if (!isNaN(elev) && elev > currentElevation && elev >= minElevation) {
                        return [nLat, nLng];
                    }
                } catch (e) {}
            }
        }
        return null;
    }

    async function drawRouteToSafety(lat1, lng1, lat2, lng2) {
        clearRoute();
        const apiKey = '5b3ce3597851110001cf6248ad5dedd05080450faf88308b1776f966';
        const url = `https://api.openrouteservice.org/v2/directions/driving-car/geojson`;
        const body = {
            coordinates: [ [lng1, lat1], [lng2, lat2] ]
        };
        try {
            let resp = await fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': apiKey
                },
                body: JSON.stringify(body)
            });
            let data = await resp.json();
            if (data && data.features && data.features[0]) {
                let coords = data.features[0].geometry.coordinates.map(c => [c[1], c[0]]);
                
                // Create green arrow polyline (thicker)
                routeLayer = L.polyline(coords, {
                    color: '#ff0000', 
                    weight: 10,
                    opacity: 0.9,
                    dashArray: '15, 8',
                    lineCap: 'round',
                    lineJoin: 'round'
                }).addTo(map);
                
                // Add arrow markers along the route
                const arrowSpacing = Math.max(1, Math.floor(coords.length / 5)); // Show ~5 arrows
                for (let i = arrowSpacing; i < coords.length; i += arrowSpacing) {
                    const prevCoord = coords[i - 1];
                    const currCoord = coords[i];
                    
                    // Calculate correct bearing angle (from previous point to current point)
                    const lat1 = prevCoord[0] * Math.PI / 180;
                    const lat2 = currCoord[0] * Math.PI / 180;
                    const deltaLng = (currCoord[1] - prevCoord[1]) * Math.PI / 180;
                    
                    const x = Math.sin(deltaLng) * Math.cos(lat2);
                    const y = Math.cos(lat1) * Math.sin(lat2) - Math.sin(lat1) * Math.cos(lat2) * Math.cos(deltaLng);
                    
                    let bearing = Math.atan2(x, y) * 180 / Math.PI;
                    bearing = (bearing + 360) % 360; // Normalize to 0-360
                    
                    
                }
                
                // Track this route layer
                routeLayers.push(routeLayer);
                
                map.fitBounds(routeLayer.getBounds(), {padding: [50, 50]});
            }
        } catch (e) {
            // Optionally show error
        }
    }

    map.on('click', function(e) {
        // Clear any existing routes first
        clearRoute();
        
        if (marker) map.removeLayer(marker);
        marker = L.marker(e.latlng).addTo(map);
        setRegionName('Loading...');
        
        // Defensive: check for valid lat/lng
        const lat = Number(e.latlng.lat);
        const lng = Number(e.latlng.lng);
        if (isNaN(lat) || isNaN(lng)) {
            setElevation('N/A', lat, lng, 0);
            setRegionName('Invalid location');
            return;
        }
        
        // Variable to store region name for disaster info
        let regionName = 'Unknown region';
        
        // Only call setElevation after fetching elevation
        fetch(`/elevation?lat=${lat}&lng=${lng}`)
            .then(res => res.json())
            .then(data => {
                let elev = (data && data.results && data.results[0] && data.results[0].elevation !== undefined && data.results[0].elevation !== null) ? data.results[0].elevation : NaN;
                setElevation(elev, lat, lng, 0);
            })
            .catch(() => setElevation('N/A', lat, lng, 0));
            
        fetch(`https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lng}`)
            .then(res => res.json())
            .then(data => {
                if (data.address) {
                    regionName = data.address.state || data.address.county || data.address.country || 'Unknown region';
                    setRegionName(regionName);
                    // Fetch disaster information after getting region name
                    fetchDisasterInfo(lat, lng, regionName);
                } else {
                    setRegionName('Choose valid region');
                    fetchDisasterInfo(lat, lng, 'this location');
                }
            })
            .catch(() => {
                setRegionName('Error fetching region');
                fetchDisasterInfo(lat, lng, 'this location');
            });
    });


</script>
</body>
</html>
